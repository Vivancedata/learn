// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums for type safety
enum CourseDifficulty {
  Beginner
  Intermediate
  Advanced
}

enum LessonType {
  lesson
  project
  quiz
}

enum ProjectStatus {
  pending
  approved
  rejected
}

enum UserRole {
  student
  instructor
  admin
}

model User {
  id                 String                @id @default(uuid())
  email              String                @unique
  name               String?
  password           String
  githubUsername     String?
  role               UserRole              @default(student)
  emailVerified      Boolean               @default(false)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  courses            CourseProgress[]
  paths              PathProgress[]
  discussions        Discussion[]
  discussionReplies  DiscussionReply[]
  projectSubmissions ProjectSubmission[]
  certificates       Certificate[]
  achievements       UserAchievement[]
  passwordResetTokens PasswordResetToken[]
}

model Course {
  id               String           @id
  title            String
  description      String
  difficulty       CourseDifficulty
  durationHours    Int
  pathId           String
  prerequisites    String? // JSON array - SQLite doesn't support native JSON type
  learningOutcomes String? // JSON array - SQLite doesn't support native JSON type
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  sections         CourseSection[]
  progress         CourseProgress[]
  discussions      Discussion[]
  certificates     Certificate[]
  path             Path             @relation(fields: [pathId], references: [id])

  @@index([pathId])
}

model CourseSection {
  id          String   @id @default(uuid())
  title       String
  description String?
  order       Int
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lessons     Lesson[]
  course      Course   @relation(fields: [courseId], references: [id])

  @@index([courseId])
}

model Lesson {
  id                 String              @id @default(uuid())
  title              String
  content            String
  type               LessonType
  duration           String?
  hasProject         Boolean             @default(false)
  githubUrl          String?
  nextLessonId       String?
  prevLessonId       String?
  sectionId          String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  section            CourseSection       @relation(fields: [sectionId], references: [id])
  quizQuestions      QuizQuestion[]
  completedBy        CourseProgress[]    @relation("CompletedLessons")
  projectSubmissions ProjectSubmission[]
  discussions        Discussion[]

  @@index([sectionId])
}

model QuizQuestion {
  id            String   @id @default(uuid())
  question      String
  options       String // JSON array of options - SQLite doesn't support native JSON type
  correctAnswer Int
  explanation   String?
  lessonId      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lesson        Lesson   @relation(fields: [lessonId], references: [id])

  @@index([lessonId])
}

model Path {
  id             String         @id
  title          String
  description    String
  icon           String?
  estimatedHours Int?
  difficulty     String?
  prerequisites  String? // JSON array - SQLite doesn't support native JSON type
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  courses        Course[]
  progress       PathProgress[]
}

model CourseProgress {
  id               String      @id @default(uuid())
  userId           String
  courseId         String
  completedLessons Lesson[]    @relation("CompletedLessons")
  lastAccessed     DateTime    @default(now())
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  user             User        @relation(fields: [userId], references: [id])
  course           Course      @relation(fields: [courseId], references: [id])
  quizScores       QuizScore[]

  @@index([userId, courseId])
}

model QuizScore {
  id               String         @id @default(uuid())
  courseProgressId String
  lessonId         String
  score            Int
  maxScore         Int
  completedAt      DateTime       @default(now())
  courseProgress   CourseProgress @relation(fields: [courseProgressId], references: [id])

  @@index([courseProgressId])
  @@index([lessonId])
}

model PathProgress {
  id           String   @id @default(uuid())
  userId       String
  pathId       String
  startedAt    DateTime @default(now())
  lastAccessed DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
  path         Path     @relation(fields: [pathId], references: [id])

  @@index([userId, pathId])
}

model ProjectSubmission {
  id          String        @id @default(uuid())
  userId      String
  lessonId    String
  githubUrl   String
  liveUrl     String?
  notes       String?
  status      ProjectStatus @default(pending)
  feedback    String?
  submittedAt DateTime      @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])
  lesson      Lesson        @relation(fields: [lessonId], references: [id])

  @@index([userId])
  @@index([lessonId])
  @@index([status])
}

model Discussion {
  id        String            @id @default(uuid())
  userId    String
  content   String
  courseId  String?
  lessonId  String?
  likes     Int               @default(0)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  user      User              @relation(fields: [userId], references: [id])
  course    Course?           @relation(fields: [courseId], references: [id])
  lesson    Lesson?           @relation(fields: [lessonId], references: [id])
  replies   DiscussionReply[]

  @@index([userId])
  @@index([courseId])
  @@index([lessonId])
}

model DiscussionReply {
  id           String     @id @default(uuid())
  userId       String
  discussionId String
  content      String
  likes        Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  user         User       @relation(fields: [userId], references: [id])
  discussion   Discussion @relation(fields: [discussionId], references: [id])

  @@index([userId])
  @@index([discussionId])
}

model Certificate {
  id               String    @id @default(uuid())
  userId           String
  courseId         String
  issueDate        DateTime  @default(now())
  expiryDate       DateTime?
  verificationCode String    @unique
  skills           String // JSON array of skills - SQLite doesn't support native JSON type
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id])
  course           Course    @relation(fields: [courseId], references: [id])

  @@index([userId])
  @@index([courseId])
}

model Achievement {
  id               String            @id @default(uuid())
  name             String
  description      String
  icon             String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  userAchievements UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  earnedAt      DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}
