// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums for type safety
enum CourseDifficulty {
  Beginner
  Intermediate
  Advanced
}

enum LessonType {
  lesson
  project
  quiz
}

enum ProjectStatus {
  pending
  approved
  rejected
}

enum UserRole {
  student
  instructor
  admin
}

enum RecommendationType {
  CONTINUE_PATH      // Next course in learning path
  SIMILAR_TOPIC      // Based on completed courses
  SKILL_GAP          // Based on assessment results
  POPULAR            // Trending among similar users
  PREREQUISITE_MET   // User now qualifies for this
  COMPLEMENT         // Complements recent learning
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
  CODE_OUTPUT
  FILL_BLANK
}

// Leaderboard enums
enum LeaderboardType {
  XP
  STREAKS
  COURSES_COMPLETED
  LESSONS_COMPLETED
  HELPING_POINTS
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum VideoProvider {
  YOUTUBE
  VIMEO
  WISTIA
  SELF_HOSTED
}

model User {
  id                      String                   @id @default(uuid())
  email                   String                   @unique
  name                    String?
  password                String
  githubUsername          String?
  role                    UserRole                 @default(student)
  emailVerified           Boolean                  @default(false)
  points                  Int                      @default(0)
  showOnLeaderboard       Boolean                  @default(true)
  currentStreak           Int                      @default(0)
  longestStreak           Int                      @default(0)
  lastActivityDate        DateTime?
  streakFreezes           Int                      @default(0)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  courses                 CourseProgress[]
  paths                   PathProgress[]
  discussions             Discussion[]
  discussionReplies       DiscussionReply[]
  projectSubmissions      ProjectSubmission[]
  certificates            Certificate[]
  achievements            UserAchievement[]
  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  pointsReceived          CommunityPoint[]         @relation("PointsReceived")
  pointsGiven             CommunityPoint[]         @relation("PointsGiven")
  projectLikes            ProjectLike[]
  pushSubscriptions       PushSubscription[]
  notificationPreference  NotificationPreference?
  recommendations         CourseRecommendation[]
  dailyActivities         DailyActivity[]
  leaderboardEntries      LeaderboardCache[]
  assessmentAttempts      AssessmentAttempt[]
  subscription            Subscription?
  conversations           Conversation[]
}

model Course {
  id               String                 @id
  title            String
  description      String
  difficulty       CourseDifficulty
  durationHours    Int
  pathId           String
  prerequisites    String? // JSON array - SQLite doesn't support native JSON type
  learningOutcomes String? // JSON array - SQLite doesn't support native JSON type
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  sections         CourseSection[]
  progress         CourseProgress[]
  discussions      Discussion[]
  certificates     Certificate[]
  recommendations  CourseRecommendation[]
  assessments      SkillAssessment[]
  path             Path                   @relation(fields: [pathId], references: [id])

  @@index([pathId])
}

model CourseSection {
  id          String   @id @default(uuid())
  title       String
  description String?
  order       Int
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lessons     Lesson[]
  course      Course   @relation(fields: [courseId], references: [id])

  @@index([courseId])
}

model Lesson {
  id                 String              @id @default(uuid())
  title              String
  content            String
  type               LessonType
  duration           String?
  hasProject         Boolean             @default(false)
  githubUrl          String?
  nextLessonId       String?
  prevLessonId       String?
  sectionId          String
  // Video content fields
  videoUrl           String?             // YouTube, Vimeo, or self-hosted URL
  videoDuration      Int?                // Duration in seconds
  videoProvider      VideoProvider?
  videoTranscript    String?             // Optional video transcript
  videoChapters      String?             // JSON array of chapter markers
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  section            CourseSection       @relation(fields: [sectionId], references: [id])
  quizQuestions      QuizQuestion[]
  completedBy        CourseProgress[]    @relation("CompletedLessons")
  projectSubmissions ProjectSubmission[]
  discussions        Discussion[]
  videoProgress      VideoProgress[]

  @@index([sectionId])
}

model QuizQuestion {
  id            String   @id @default(uuid())
  question      String
  options       String // JSON array of options - SQLite doesn't support native JSON type
  correctAnswer Int
  explanation   String?
  lessonId      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lesson        Lesson   @relation(fields: [lessonId], references: [id])

  @@index([lessonId])
}

model Path {
  id             String         @id
  title          String
  description    String
  icon           String?
  estimatedHours Int?
  difficulty     String?
  prerequisites  String? // JSON array - SQLite doesn't support native JSON type
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  courses        Course[]
  progress       PathProgress[]
}

model CourseProgress {
  id               String      @id @default(uuid())
  userId           String
  courseId         String
  completedLessons Lesson[]    @relation("CompletedLessons")
  lastAccessed     DateTime    @default(now())
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  user             User        @relation(fields: [userId], references: [id])
  course           Course      @relation(fields: [courseId], references: [id])
  quizScores       QuizScore[]

  @@index([userId, courseId])
}

model QuizScore {
  id               String         @id @default(uuid())
  courseProgressId String
  lessonId         String
  score            Int
  maxScore         Int
  completedAt      DateTime       @default(now())
  courseProgress   CourseProgress @relation(fields: [courseProgressId], references: [id])

  @@index([courseProgressId])
  @@index([lessonId])
}

model PathProgress {
  id           String   @id @default(uuid())
  userId       String
  pathId       String
  startedAt    DateTime @default(now())
  lastAccessed DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
  path         Path     @relation(fields: [pathId], references: [id])

  @@index([userId, pathId])
}

model ProjectSubmission {
  id          String        @id @default(uuid())
  userId      String
  lessonId    String
  githubUrl   String
  liveUrl     String?
  notes       String?
  status      ProjectStatus @default(pending)
  feedback    String?
  submittedAt DateTime      @default(now())
  reviewedAt  DateTime?
  reviewedBy  String?
  isPublic    Boolean       @default(false)
  description String?
  likesCount  Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])
  lesson      Lesson        @relation(fields: [lessonId], references: [id])
  likes       ProjectLike[]

  @@index([userId])
  @@index([lessonId])
  @@index([status])
  @@index([isPublic])
}

model ProjectLike {
  id           String            @id @default(uuid())
  userId       String
  submissionId String
  createdAt    DateTime          @default(now())
  user         User              @relation(fields: [userId], references: [id])
  submission   ProjectSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([userId, submissionId])
  @@index([userId])
  @@index([submissionId])
}

model Discussion {
  id              String            @id @default(uuid())
  userId          String
  content         String
  courseId        String?
  lessonId        String?
  likes           Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  user            User              @relation(fields: [userId], references: [id])
  course          Course?           @relation(fields: [courseId], references: [id])
  lesson          Lesson?           @relation(fields: [lessonId], references: [id])
  replies         DiscussionReply[]
  communityPoints CommunityPoint[]

  @@index([userId])
  @@index([courseId])
  @@index([lessonId])
}

model DiscussionReply {
  id              String           @id @default(uuid())
  userId          String
  discussionId    String
  content         String
  likes           Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  user            User             @relation(fields: [userId], references: [id])
  discussion      Discussion       @relation(fields: [discussionId], references: [id])
  communityPoints CommunityPoint[]

  @@index([userId])
  @@index([discussionId])
}

model Certificate {
  id               String    @id @default(uuid())
  userId           String
  courseId         String
  issueDate        DateTime  @default(now())
  expiryDate       DateTime?
  verificationCode String    @unique
  skills           String // JSON array of skills - SQLite doesn't support native JSON type
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id])
  course           Course    @relation(fields: [courseId], references: [id])

  @@index([userId])
  @@index([courseId])
}

model Achievement {
  id               String            @id @default(uuid())
  name             String
  description      String
  icon             String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  userAchievements UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  earnedAt      DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  code      String   // 6-digit verification code
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([code])
}

model CommunityPoint {
  id           String            @id @default(uuid())
  recipientId  String
  giverId      String
  discussionId String?
  replyId      String?
  reason       String?
  createdAt    DateTime          @default(now())
  recipient    User              @relation("PointsReceived", fields: [recipientId], references: [id])
  giver        User              @relation("PointsGiven", fields: [giverId], references: [id])
  discussion   Discussion?       @relation(fields: [discussionId], references: [id])
  reply        DiscussionReply?  @relation(fields: [replyId], references: [id])

  @@unique([giverId, discussionId])
  @@unique([giverId, replyId])
  @@index([recipientId])
  @@index([giverId])
  @@index([discussionId])
  @@index([replyId])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dh    String   // Public key for push encryption
  auth      String   // Auth secret for push encryption
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationPreference {
  id                String  @id @default(uuid())
  userId            String  @unique
  streakReminders   Boolean @default(true)
  courseUpdates     Boolean @default(true)
  achievementAlerts Boolean @default(true)
  weeklyProgress    Boolean @default(true)
  communityReplies  Boolean @default(true)
  marketingEmails   Boolean @default(false)
  quietHoursStart   Int?    // Hour (0-23)
  quietHoursEnd     Int?    // Hour (0-23)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CourseRecommendation {
  id         String             @id @default(uuid())
  userId     String
  courseId   String
  score      Float // 0-1 relevance score
  reason     String // Human-readable explanation of why recommended
  reasonType RecommendationType
  dismissed  Boolean            @default(false)
  clicked    Boolean            @default(false)
  enrolled   Boolean            @default(false)
  createdAt  DateTime           @default(now())
  expiresAt  DateTime

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId, dismissed])
  @@index([expiresAt])
}

model DailyActivity {
  id               String   @id @default(uuid())
  userId           String
  date             DateTime
  xpEarned         Int      @default(0)
  lessonsCompleted Int      @default(0)
  quizzesTaken     Int      @default(0)
  timeSpentMinutes Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model LeaderboardCache {
  id           String            @id @default(uuid())
  type         LeaderboardType
  period       LeaderboardPeriod
  rank         Int
  userId       String
  score        Int
  previousRank Int?
  metadata     String?           // JSON for extra data like streak days, course names
  calculatedAt DateTime          @default(now())
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([type, period, userId])
  @@index([type, period, rank])
  @@index([userId])
}

model VideoProgress {
  id             String   @id @default(uuid())
  lessonId       String
  userId         String
  watchedSeconds Int      @default(0)  // Current position in seconds
  totalSeconds   Int                   // Total video duration in seconds
  completed      Boolean  @default(false)
  lastWatched    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lesson         Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, userId])
  @@index([lessonId])
  @@index([userId])
}

// Skill Assessment Models
model SkillAssessment {
  id             String             @id @default(uuid())
  name           String             // "Python Fundamentals", "SQL Basics"
  slug           String             @unique
  description    String
  courseId       String?            // Optional link to course
  difficulty     CourseDifficulty
  timeLimit      Int                // minutes
  passingScore   Int                // percentage
  totalQuestions Int
  skillArea      String             // "Python", "SQL", "Machine Learning", etc.
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  questions AssessmentQuestion[]
  attempts  AssessmentAttempt[]
  course    Course?              @relation(fields: [courseId], references: [id])

  @@index([courseId])
  @@index([skillArea])
}

model AssessmentQuestion {
  id            String       @id @default(uuid())
  assessmentId  String
  question      String
  questionType  QuestionType
  options       String       // JSON array - SQLite doesn't support native JSON type
  correctAnswer String       // JSON (supports multiple correct for multi-select)
  explanation   String
  difficulty    Int          // 1-5, for adaptive scoring
  points        Int          @default(10)
  codeSnippet   String?      // Optional code snippet for CODE_OUTPUT questions

  assessment SkillAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([difficulty])
}

model AssessmentAttempt {
  id           String   @id @default(uuid())
  userId       String
  assessmentId String
  score        Int      // percentage
  correctCount Int
  totalCount   Int
  timeSpent    Int      // seconds
  answers      String   // JSON of user answers
  passed       Boolean
  completedAt  DateTime @default(now())

  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessment SkillAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assessmentId])
  @@index([userId, assessmentId])
}

// ============================================================================
// Subscription & Payment Models
// ============================================================================

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
  incomplete
  incomplete_expired
  unpaid
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  status               SubscriptionStatus @default(incomplete)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

model WebhookEvent {
  id            String   @id @default(uuid())
  stripeEventId String   @unique
  eventType     String
  processed     Boolean  @default(false)
  payload       String   // JSON payload for debugging
  error         String?  // Error message if processing failed
  createdAt     DateTime @default(now())
  processedAt   DateTime?

  @@index([stripeEventId])
  @@index([processed])
}

// ============================================================================
// AI Tutor Models
// ============================================================================

model Conversation {
  id        String                @id @default(uuid())
  userId    String
  title     String?
  lessonId  String?
  courseId  String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ConversationMessage[]

  @@index([userId])
  @@index([lessonId])
  @@index([courseId])
}

model ConversationMessage {
  id             String       @id @default(uuid())
  conversationId String
  role           String       // 'user' | 'assistant' | 'system'
  content        String
  tokenCount     Int?         // Track token usage
  createdAt      DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

// AI Tutor usage tracking for rate limiting
model AITutorUsage {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime // Date only, for daily limit tracking
  messages  Int      @default(0)
  tokens    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}
